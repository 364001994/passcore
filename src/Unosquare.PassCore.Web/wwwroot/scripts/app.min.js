(function () {
    'use strict';

    var app = angular.module('app', ['ngRoute', 'ui.bootstrap', 'vcRecaptcha'])
        .filter('unsafe', ['$sce', function ($sce) { return $sce.trustAsHtml; }]);
})();
(function () {
    'use strict';

    angular.module('app').constant("ViewOptions", {
        ApplicationTitle: "Self-Service Account Management Tools",
        ChangePasswordTitle: "Change Account Password",
        ChangePasswordForm: {
            UsernameLabel: "Username",
            UsernamePlaceholder: "username@domain.com",
            UsernameHelpblock: "Your organization's username",
            CurrentPasswordLabel: "Current Password",
            CurrentPasswordPlaceholder: "",
            CurrentPasswordHelpblock: "Enter your current password",
            NewPasswordLabel: "New Password",
            NewPasswordPlaceholder: "",
            NewPasswordHelpblock: "Enter a strong password. You can use <a href='http://passwordsgenerator.net/' target='_blank'>this tool</a> to help you create one.",
            NewPasswordVerifyLabel: "Re-enter New Password",
            NewPasswordVerifyPlaceholder: "",
            NewPasswordVerifyHelpblock: "Enter your new password again"
        },
        ErrorMessages: {
            0: "System Error",
            1: "Field is required",
            2: "Fields don't match",
            3: "We could not find you user account",
            4: "The username and current password you provided are invalid",
            5: "Could not verify you are not a robot"
        },
        Recaptcha: {
            IsEnabled: false,
            SiteKey: "000000000000000000000-000000000000000000"
        },
        Alerts: {
            SuccessAlertTitle: "You have changed your password successfully.",
            SuccessAlertBody: "Please note it may take a few hours for your new password to reach all domain controllers.",
            ErrorAlertTitle: "There was an error changing your password",
            ErrorAlertBody: "Error Information: "
        }
    });
})();
(function() {
    'use strict';

    angular.module('app').config([
        '$routeProvider', '$locationProvider', 'ViewOptions', function ($routeProvider, $locationProvider, ViewOptions) {
            $routeProvider.
                when('/', {
                    templateUrl: 'views/change-password.html',
                    title: ViewOptions.ChangePasswordTitle
                }).otherwise({
                    redirectTo: '/'
                });

            $locationProvider.html5Mode(true);
        }
    ]);
})();
(function () {
    'use strict';

    angular.module('app')
        .controller('TitleCtrl', [
            '$scope', '$route', '$location', '$routeParams', 'ViewOptions',
            function ($scope, $route, $location, $routeParams, ViewOptions) {
                var me = this;
                me.content = ViewOptions.ApplicationTitle;

                $scope.$on('$routeChangeSuccess', function () {
                    me.content = $route.current.title + " - " + ViewOptions.ApplicationTitle;
                });
            }
        ]).controller('ChangePasswordCtrl', [
            '$scope', '$http', '$sce', 'vcRecaptchaService', 'ViewOptions',
            function ($scope, $http, $sce, recaptcha, ViewOptions) {
                var me = this;

                $scope.ViewOptions = ViewOptions;
                $scope.ShowSuccessAlert = false;
                $scope.ShowErrorAlert = false;
                $scope.ErrorAlertMessage = '';

                $scope.FormData = {
                    Username: '',
                    CurrentPassword: '',
                    NewPassword: '',
                    NewPasswordVerify: '',
                    Recaptcha: '',
                };

                $scope.EmptyFormData = angular.copy($scope.FormData);

                $scope.SetRecaptchaResponse = function (response) {
                    $scope.FormData.Recaptcha = response;
                };

                $scope.ClearRecaptchaResponse = function () {
                    $scope.FormData.Recaptcha = '';
                };

                $scope.Submit = function () {
                    $('div.form-overlay').show();
                    
                    $.each($scope.Form, function (index, field) {
                        if (!field) return;
                        if (field.$valid == undefined) return;

                        field.Validation = { HasError: false, ErrorMessage: '' };
                    });

                    $scope.Form.$setUntouched();
                    
                    $scope.ShowSuccessAlert = false;
                    $scope.ShowErrorAlert = false;
                    $scope.ErrorAlertMessage = '';

                    $http({
                        method: 'POST',
                        url: 'api/password',
                        data: $scope.FormData,
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(function successCallback(response) {
                        $('div.form-overlay').hide();
                        $scope.FormData = angular.copy($scope.EmptyFormData);
                        $scope.ShowSuccessAlert = true;

                    }, function errorCallback(response) {
                        $('div.form-overlay').hide();
                        grecaptcha.reset();

                        $.each(response.data.Errors, function (index, errorData) {
                            if (errorData.ErrorType == 1)
                            {
                                $scope.ShowErrorAlert = true;
                                if (errorData.ErrorCode == 0) {
                                    $scope.ErrorAlertMessage = ViewOptions.Alerts.ErrorAlertBody + errorData.Message;
                                } else {
                                    $scope.ErrorAlertMessage = ViewOptions.Alerts.ErrorAlertBody + $scope.ViewOptions.ErrorMessages[errorData.ErrorCode];
                                }
                                
                            }
                            else if (errorData.ErrorType == 2) {
                                $scope.Form[errorData.FieldName].Validation.HasError = true;
                                $scope.Form[errorData.FieldName].Validation.ErrorMessage = $scope.ViewOptions.ErrorMessages[errorData.ErrorCode];
                            }
                        });
                    });
                }
            }
        ]);
})();