(function () {
    'use strict';

    var app = angular.module('app', ['ngRoute', 'ui.bootstrap']);

    app.filter('unsafe', ['$sce', function($sce) { return $sce.trustAsHtml; }]);
})();
(function () {
    'use strict';

    angular.module('app').constant("ViewOptions", {
        ApplicationTitle: "Self-Service Account Management Tools",
        ChangePasswordTitle: "Change Account Password",
        ChangePasswordForm: {
            UsernameLabel: "Username",
            UsernamePlaceholder: "username@domain.com",
            UsernameHelpblock: "Your organization's username",
            CurrentPasswordLabel: "Current Password",
            CurrentPasswordPlaceholder: "",
            CurrentPasswordHelpblock: "Enter your current password",
            NewPasswordLabel: "New Password",
            NewPasswordPlaceholder: "",
            NewPasswordHelpblock: 'Enter a strong password. You can use <a href="http://passwordsgenerator.net/" target="_blank">this tool</a> to help you create one.',
            NewPasswordVerifyLabel: "Re-enter New Password",
            NewPasswordVerifyPlaceholder: "",
            NewPasswordVerifyHelpblock: "Enter your new password again"
        },
        ErrorMessages: {
            0: "General Error",
            1: "Field is required",
            2: "Fields don't match",
            3: "User was not found",
            4: "The credentials provided are invalid"
        }
    });
})();
(function() {
    'use strict';

    angular.module('app').config([
        '$routeProvider', '$locationProvider', 'ViewOptions', function ($routeProvider, $locationProvider, ViewOptions) {
            $routeProvider.
                when('/', {
                    templateUrl: 'views/change-password.html',
                    title: ViewOptions.ChangePasswordTitle
                }).otherwise({
                    redirectTo: '/'
                });

            $locationProvider.html5Mode(true);
        }
    ]);
})();
(function () {
    'use strict';

    angular.module('app')
        .controller('TitleCtrl', [
            '$scope', '$route', '$location', '$routeParams', 'ViewOptions',
            function ($scope, $route, $location, $routeParams, ViewOptions) {
                var me = this;
                me.content = ViewOptions.ApplicationTitle;

                $scope.$on('$routeChangeSuccess', function () {
                    me.content = $route.current.title + " - " + ViewOptions.ApplicationTitle;
                });
            }
        ]).controller('ChangePasswordCtrl', [
            '$scope', '$http', '$sce', 'ViewOptions',
            function ($scope, $http, $sce, ViewOptions) {
                var me = this;

                $scope.ViewOptions = ViewOptions;

                $scope.FormData = {
                    Username: '',
                    CurrentPassword: '',
                    NewPassword: '',
                    NewPasswordVerify: '',
                };

                $scope.EmptyFormData = angular.copy($scope.FormData);

                $scope.Submit = function () {
                    $('div.form-overlay').show();

                    $.each($scope.Form, function (index, field) {
                        if (!field) return;
                        if (field.$valid == undefined) return;

                        field.Validation = { HasError: false, ErrorMessage: '' };
                    });

                    $scope.Form.$setUntouched();

                    $http({
                        method: 'POST',
                        url: 'api/password',
                        data: $scope.FormData,
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(function successCallback(response) {
                        $('div.form-overlay').hide();
                        // this callback will be called asynchronously
                        // when the response is available
                        $scope.FormData = angular.copy($scope.EmptyFormData);
                    }, function errorCallback(response) {
                        $('div.form-overlay').hide();

                        $.each(response.data.Errors, function (index, errorData) {
                            if (errorData.ErrorType == 2) {
                                $scope.Form[errorData.FieldName].Validation.HasError = true;
                                $scope.Form[errorData.FieldName].Validation.ErrorMessage = $scope.ViewOptions.ErrorMessages[errorData.ErrorCode];
                            }
                        });
                    });
                }
            }
        ]);
})();